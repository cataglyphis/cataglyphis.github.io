<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>ProxySQL Helm Chart 部署</title>
    <link href="/2023/06/29/01/"/>
    <url>/2023/06/29/01/</url>
    
    <content type="html"><![CDATA[<p>ProxySQL 官方的 Helm Chart 长期未更新，为了方便在 Kuberneters 中部署，重新编写了 ProxySQL Helm Chart。功能包括：</p><ul><li>支持将 ProxySQL 的配置存储到 PV 中</li><li>支持以 NodePort 的形式暴露 ProxySQL 服务，用于跨集群访问</li></ul><span id="more"></span><h2 id="Chart"><a href="#Chart" class="headerlink" title="Chart"></a>Chart</h2><p>Chart 文件目录结构如下：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus">├── Chart<span class="hljs-selector-class">.yaml</span><br>├── templates<br>│   ├── NOTES<span class="hljs-selector-class">.txt</span><br>│   ├── _helpers<span class="hljs-selector-class">.tpl</span><br>│   ├── statefuleset<span class="hljs-selector-class">.yaml</span><br>│   ├── svc-headless<span class="hljs-selector-class">.yaml</span><br>│   ├── svc<span class="hljs-selector-class">.yaml</span><br>│   └── tests<br>│       └── test-connection<span class="hljs-selector-class">.yaml</span><br>└── values.yaml<br></code></pre></td></tr></table></figure><p>Chart.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v2</span><br><span class="hljs-attr">name:</span> <span class="hljs-string">proxysql</span><br><span class="hljs-attr">description:</span> <span class="hljs-string">ProxySQL</span> <span class="hljs-string">Helm</span> <span class="hljs-string">Chart</span> <span class="hljs-string">for</span> <span class="hljs-string">Kubernetes</span><br><br><span class="hljs-attr">type:</span> <span class="hljs-string">application</span><br><span class="hljs-attr">version:</span> <span class="hljs-number">0.1</span><span class="hljs-number">.0</span><br><span class="hljs-attr">appVersion:</span> <span class="hljs-string">&quot;1.16.0&quot;</span><br></code></pre></td></tr></table></figure><h2 id="helpers-tpl"><a href="#helpers-tpl" class="headerlink" title="_helpers.tpl"></a>_helpers.tpl</h2><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="hljs-template-tag">&#123;&#123;/*</span><br><span class="hljs-template-tag"><span class="hljs-name">Expand</span> <span class="hljs-name">the</span> <span class="hljs-name">name</span> <span class="hljs-name">of</span> <span class="hljs-name">the</span> <span class="hljs-name">chart</span>.</span><br><span class="hljs-template-tag">*/&#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> define <span class="hljs-string">&quot;proxysql.name&quot;</span> -&#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> default .Chart.Name .Values.nameOverride | trunc <span class="hljs-number">63</span> | trimSuffix <span class="hljs-string">&quot;-&quot;</span> &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> end &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;&#123;/*</span><br><span class="hljs-template-tag"><span class="hljs-name">Create</span> <span class="hljs-name">a</span> <span class="hljs-name">default</span> <span class="hljs-name">fully</span> <span class="hljs-name">qualified</span> <span class="hljs-name">app</span> <span class="hljs-name">name</span>.</span><br><span class="hljs-template-tag"><span class="hljs-name">We</span> <span class="hljs-name">truncate</span> <span class="hljs-name">at</span> <span class="hljs-name">63</span> <span class="hljs-name">chars</span> <span class="hljs-name">because</span> <span class="hljs-name">some</span> <span class="hljs-name">Kubernetes</span> <span class="hljs-name">name</span> <span class="hljs-name">fields</span> <span class="hljs-name">are</span> <span class="hljs-name">limited</span> <span class="hljs-name">to</span> <span class="hljs-name">this</span> (<span class="hljs-name">by</span> <span class="hljs-name">the</span> <span class="hljs-name">DNS</span> <span class="hljs-name">naming</span> <span class="hljs-name">spec</span>).</span><br><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-built_in">If</span></span> <span class="hljs-name">release</span> <span class="hljs-name">name</span> <span class="hljs-name">contains</span> <span class="hljs-name">chart</span> <span class="hljs-name">name</span> <span class="hljs-name">it</span> <span class="hljs-name">will</span> <span class="hljs-name">be</span> <span class="hljs-name">used</span> <span class="hljs-name">as</span> <span class="hljs-name">a</span> <span class="hljs-name">full</span> <span class="hljs-name">name</span>.</span><br><span class="hljs-template-tag">*/&#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> define <span class="hljs-string">&quot;proxysql.fullname&quot;</span> -&#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> if .Values.fullnameOverride &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> .Values.fullnameOverride | trunc <span class="hljs-number">63</span> | trimSuffix <span class="hljs-string">&quot;-&quot;</span> &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> else &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> $name <span class="hljs-attr">:</span>= default .Chart.Name .Values.nameOverride &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> if contains $name .Release.Name &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> .Release.Name | trunc <span class="hljs-number">63</span> | trimSuffix <span class="hljs-string">&quot;-&quot;</span> &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> else &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> printf <span class="hljs-string">&quot;%s-%s&quot;</span> .Release.Name $name | trunc <span class="hljs-number">63</span> | trimSuffix <span class="hljs-string">&quot;-&quot;</span> &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> end &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> end &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> end &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;&#123;/*</span><br><span class="hljs-template-tag"><span class="hljs-name">Create</span> <span class="hljs-name">chart</span> <span class="hljs-name">name</span> <span class="hljs-name">and</span> <span class="hljs-name">version</span> <span class="hljs-name">as</span> <span class="hljs-name">used</span> <span class="hljs-name">by</span> <span class="hljs-name">the</span> <span class="hljs-name">chart</span> <span class="hljs-name">label</span>.</span><br><span class="hljs-template-tag">*/&#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> define <span class="hljs-string">&quot;proxysql.chart&quot;</span> -&#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> printf <span class="hljs-string">&quot;%s-%s&quot;</span> .Chart.Name .Chart.Version | replace <span class="hljs-string">&quot;+&quot;</span> <span class="hljs-string">&quot;_&quot;</span> | trunc <span class="hljs-number">63</span> | trimSuffix <span class="hljs-string">&quot;-&quot;</span> &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> end &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;&#123;/*</span><br><span class="hljs-template-tag"><span class="hljs-name">Common</span> <span class="hljs-name">labels</span></span><br><span class="hljs-template-tag">*/&#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> define <span class="hljs-string">&quot;proxysql.labels&quot;</span> -&#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml">helm.sh/chart: </span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">include</span> <span class="hljs-string">&quot;proxysql.chart&quot;</span> . &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">include</span> <span class="hljs-string">&quot;proxysql.selectorLabels&quot;</span> . &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> if .Chart.AppVersion &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml">app.kubernetes.io/version: </span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">.Chart.AppVersion</span> | quote &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> end &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml">app.kubernetes.io/managed-by: </span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">.Release.Service</span> &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> end &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-tag">&#123;&#123;/*</span><br><span class="hljs-template-tag"><span class="hljs-name">Selector</span> <span class="hljs-name">labels</span></span><br><span class="hljs-template-tag">*/&#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> define <span class="hljs-string">&quot;proxysql.selectorLabels&quot;</span> -&#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml">app.kubernetes.io/name: </span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">include</span> <span class="hljs-string">&quot;proxysql.name&quot;</span> . &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml">app.kubernetes.io/instance: </span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">.Release.Name</span> &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">-</span> end &#125;&#125;</span><br></code></pre></td></tr></table></figure><h2 id="statefulset-yaml"><a href="#statefulset-yaml" class="headerlink" title="statefulset.yaml"></a>statefulset.yaml</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> &#123;&#123; <span class="hljs-string">template</span> <span class="hljs-string">&quot;proxysql.fullname&quot;</span> <span class="hljs-string">.</span> &#125;&#125;<br>  <span class="hljs-attr">labels:</span> &#123;&#123;<span class="hljs-bullet">-</span> <span class="hljs-string">include</span> <span class="hljs-string">&quot;proxysql.labels&quot;</span> <span class="hljs-string">.</span> <span class="hljs-string">|</span> <span class="hljs-string">nindent</span> <span class="hljs-number">4</span> &#125;&#125;<br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span> &#123;&#123;<span class="hljs-bullet">-</span> <span class="hljs-string">include</span> <span class="hljs-string">&quot;proxysql.selectorLabels&quot;</span> <span class="hljs-string">.</span> <span class="hljs-string">|</span> <span class="hljs-string">nindent</span> <span class="hljs-number">6</span> &#125;&#125;<br>  <span class="hljs-attr">serviceName:</span> &#123;&#123; <span class="hljs-string">template</span> <span class="hljs-string">&quot;proxysql.fullname&quot;</span> <span class="hljs-string">.</span> &#125;&#125;<span class="hljs-string">-headless</span><br>  <span class="hljs-attr">replicas:</span> &#123;&#123; <span class="hljs-string">.Values.replicaCount</span> &#125;&#125;<br>  <span class="hljs-attr">minReadySeconds:</span> <span class="hljs-number">5</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span> &#123;&#123;<span class="hljs-bullet">-</span> <span class="hljs-string">include</span> <span class="hljs-string">&quot;proxysql.selectorLabels&quot;</span> <span class="hljs-string">.</span> <span class="hljs-string">|</span> <span class="hljs-string">nindent</span> <span class="hljs-number">8</span> &#125;&#125;<br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">terminationGracePeriodSeconds:</span> <span class="hljs-number">10</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">proxysql</span><br>        <span class="hljs-attr">image:</span> &#123;&#123; <span class="hljs-string">.Values.image</span> &#125;&#125;<br>        <span class="hljs-attr">imagePullPolicy:</span> &#123;&#123; <span class="hljs-string">.Values.imagePullPolicy</span> &#125;&#125;<br>        <span class="hljs-attr">resources:</span><br>          &#123;&#123;<span class="hljs-bullet">-</span> <span class="hljs-string">toYaml</span> <span class="hljs-string">.Values.resources</span> <span class="hljs-string">|</span> <span class="hljs-string">nindent</span> <span class="hljs-number">10</span> &#125;&#125;<br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">admin</span><br>          <span class="hljs-attr">containerPort:</span> <span class="hljs-number">6032</span><br>          <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">proxysql</span><br>          <span class="hljs-attr">containerPort:</span> <span class="hljs-number">6033</span><br>          <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">proxysql-data</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/lib/proxysql</span><br>        <span class="hljs-attr">livenessProbe:</span><br>          <span class="hljs-attr">tcpSocket:</span><br>            <span class="hljs-attr">port:</span> <span class="hljs-string">admin</span><br>          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">10</span><br>          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span><br>          <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">1</span><br>          <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>          <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span><br>        <span class="hljs-attr">readinessProbe:</span><br>          <span class="hljs-attr">tcpSocket:</span><br>            <span class="hljs-attr">port:</span> <span class="hljs-string">admin</span><br>          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">10</span><br>          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span><br>          <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">1</span><br>          <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>          <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span><br>        <span class="hljs-attr">startupProbe:</span><br>          <span class="hljs-attr">tcpSocket:</span><br>            <span class="hljs-attr">port:</span> <span class="hljs-string">admin</span><br>          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">10</span><br>          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">3</span><br>          <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">1</span><br>          <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>          <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">volumeClaimTemplates:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">proxysql-data</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">accessModes:</span> [ <span class="hljs-string">&quot;ReadWriteOnce&quot;</span> ]<br>      <span class="hljs-attr">resources:</span><br>        <span class="hljs-attr">requests:</span><br>          <span class="hljs-attr">storage:</span> <span class="hljs-string">1Gi</span><br>      <span class="hljs-attr">storageClassName:</span> &#123;&#123; <span class="hljs-string">.Values.storageClassName</span> &#125;&#125;<br></code></pre></td></tr></table></figure><h2 id="svc-headless"><a href="#svc-headless" class="headerlink" title="svc-headless"></a>svc-headless</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> &#123;&#123; <span class="hljs-string">include</span> <span class="hljs-string">&quot;proxysql.fullname&quot;</span> <span class="hljs-string">.</span> &#125;&#125;<span class="hljs-string">-headless</span><br>  <span class="hljs-attr">labels:</span><br>    &#123;&#123;<span class="hljs-bullet">-</span> <span class="hljs-string">include</span> <span class="hljs-string">&quot;proxysql.labels&quot;</span> <span class="hljs-string">.</span> <span class="hljs-string">|</span> <span class="hljs-string">nindent</span> <span class="hljs-number">4</span> &#125;&#125;<br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">admin</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">6032</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">admin</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">proxysql</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">6033</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">proxysql</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>  <span class="hljs-attr">selector:</span><br>    &#123;&#123;<span class="hljs-bullet">-</span> <span class="hljs-string">include</span> <span class="hljs-string">&quot;proxysql.selectorLabels&quot;</span> <span class="hljs-string">.</span> <span class="hljs-string">|</span> <span class="hljs-string">nindent</span> <span class="hljs-number">4</span> &#125;&#125;<br></code></pre></td></tr></table></figure><h2 id="svc"><a href="#svc" class="headerlink" title="svc"></a>svc</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> &#123;&#123; <span class="hljs-string">include</span> <span class="hljs-string">&quot;proxysql.fullname&quot;</span> <span class="hljs-string">.</span> &#125;&#125;<br>  <span class="hljs-attr">labels:</span><br>    &#123;&#123;<span class="hljs-bullet">-</span> <span class="hljs-string">include</span> <span class="hljs-string">&quot;proxysql.labels&quot;</span> <span class="hljs-string">.</span> <span class="hljs-string">|</span> <span class="hljs-string">nindent</span> <span class="hljs-number">4</span> &#125;&#125;<br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> &#123;&#123; <span class="hljs-string">.Values.service.type</span> &#125;&#125;<br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">proxysql</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">6033</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">6033</span><br>      &#123;&#123;<span class="hljs-bullet">-</span> <span class="hljs-string">if</span> <span class="hljs-string">and</span> <span class="hljs-string">.Values.service.nodePort</span> <span class="hljs-string">(eq</span> <span class="hljs-string">.Values.service.type</span> <span class="hljs-string">&quot;NodePort&quot;</span><span class="hljs-string">)</span> &#125;&#125;<br>      <span class="hljs-attr">nodePort:</span> &#123;&#123; <span class="hljs-string">.Values.service.nodePort</span> &#125;&#125;<br>      &#123;&#123;<span class="hljs-bullet">-</span> <span class="hljs-string">end</span> &#125;&#125;<br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>  <span class="hljs-attr">selector:</span><br>    &#123;&#123;<span class="hljs-bullet">-</span> <span class="hljs-string">include</span> <span class="hljs-string">&quot;proxysql.selectorLabels&quot;</span> <span class="hljs-string">.</span> <span class="hljs-string">|</span> <span class="hljs-string">nindent</span> <span class="hljs-number">4</span> &#125;&#125;<br></code></pre></td></tr></table></figure><h2 id="values"><a href="#values" class="headerlink" title="values"></a>values</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># Default values for proxysql.</span><br><span class="hljs-comment"># This is a YAML-formatted file.</span><br><span class="hljs-comment"># Declare variables to be passed into your templates.</span><br><br><span class="hljs-attr">replicaCount:</span> <span class="hljs-number">1</span><br><br><span class="hljs-attr">image:</span> <span class="hljs-string">&quot;proxysql/proxysql:2.5.2&quot;</span><br><span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br><span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-attr">nameOverride:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attr">fullnameOverride:</span> <span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-attr">service:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">nodePort:</span> <span class="hljs-number">30630</span><br><br><span class="hljs-attr">resources:</span><br>  <span class="hljs-attr">limits:</span><br>    <span class="hljs-attr">cpu:</span> <span class="hljs-string">2000m</span><br>    <span class="hljs-attr">memory:</span> <span class="hljs-string">2Gi</span><br>  <span class="hljs-attr">requests:</span><br>    <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span><br>    <span class="hljs-attr">memory:</span> <span class="hljs-string">512Mi</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Kubernetes</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Kubernetes</tag>
      
      <tag>ProxySQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>通过 Filebeat 收集 Kubernetes Pod 日志并保存至 Elasticsearch</title>
    <link href="/2023/03/12/01/"/>
    <url>/2023/03/12/01/</url>
    
    <content type="html"><![CDATA[<p>为了便于查找和分析 Kubernetes 上运行的服务日志，将 Filebeat 以 daemonset 的形式部署在集群的各个节点上，收集指定服务的日志，并将日志暂存到 Kafka 里，再通过 Logstash 做后处理，并写入到 Elasticsearch 中。</p><p>整体的日志处理工作流为：<code>Filebeat -&gt; Kafka -&gt; Logstash -&gt; Elasticsearch</code>。</p><span id="more"></span><h2 id="Filebeat-配置"><a href="#Filebeat-配置" class="headerlink" title="Filebeat 配置"></a>Filebeat 配置</h2><p><a href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-overview.html">Filebeat</a> 主要负责读取宿主机上的服务日志，做简单的预处理后，写入 Kafka 对应的 Topic 里。相较于 Logstash，Filebeat 使用的系统资源较少，但后处理插件较少，如果需要比较复杂的处理过程推荐使用 Logstash。</p><div class="note note-info">            <p>Beats are lightweight data shippers that you install as agents on your servers to send specific types of operational data to Elasticsearch. Beats have a small footprint and use fewer system resources than Logstash.</p><p>Logstash has a larger footprint, but provides a broad array of input, filter, and output plugins for collecting, enriching, and transforming data from a variety of sources.</p>          </div><p>该阶段主要包括：</p><ul><li>Filebeat 的 input&#x2F;processors&#x2F;output 配置</li><li>如何读取宿主机上的 Kubernetes Pod 日志，以及系统日志</li></ul><h3 id="Config-Map"><a href="#Config-Map" class="headerlink" title="Config Map"></a>Config Map</h3><p><strong>input：</strong></p><ul><li>读取 <code>/var/log/pods</code> 下的 <code>*.log</code> 文件，<code>/var/log/pods</code> 直接挂载宿主机的对应目录</li><li>在消息中增加 <code>hostname</code> 字段，其值为环境变量 <code>HOSTNAME</code></li></ul><p><strong>processors：</strong></p><ul><li>将嵌套的 <code>[log][file][path]</code> 字段拷贝一份，并命名为 <code>log_file_path</code>，便于后期处理</li><li>如果仅需要采集指定路径&#x2F;namespace 下的文件，或者不采集某些文件，可以配合 <code>drop_event</code> 使用</li><li>增加 <code>namespace</code>、<code>pod</code>、<code>service</code> 三个字段，便于后期处理（该步骤也可以在后续的 Logstash 中添加）<ul><li>namespace：Pod 所在的 namespace</li><li>pod：哪个 Pod 打印的日志</li><li>service：哪个 Container 打印的日志</li></ul></li></ul><div class="note note-secondary">            <p>是否可以使用 <code>script</code> processor 通过解析 <code>log_file_path</code> 获取 <code>namespace</code>、<code>pod</code>、<code>service</code> 等信息？</p>          </div><p><strong>output：</strong></p><ul><li>将消息暂存到 Kafka 的 <code>log-collector</code> topic 中</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl apply -f filebeat_cm.yml -n &lt;namespace&gt;<br></code></pre></td></tr></table></figure><blockquote><p>filebeat_cm.yml</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">filebeat-config</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">filebeat.yml:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    filebeat.inputs:</span><br><span class="hljs-string">    - type: filestream</span><br><span class="hljs-string">      id: filebeat</span><br><span class="hljs-string">      paths:</span><br><span class="hljs-string">        - /var/log/pods/**/*.log</span><br><span class="hljs-string">        - /var/log/syslog</span><br><span class="hljs-string">        - /var/log/messages</span><br><span class="hljs-string">      fields:</span><br><span class="hljs-string">        hostname: $&#123;HOSTNAME&#125;</span><br><span class="hljs-string">      fields_under_root: true</span><br><span class="hljs-string">    processors:</span><br><span class="hljs-string">      - if:</span><br><span class="hljs-string">          or:</span><br><span class="hljs-string">            - contains:</span><br><span class="hljs-string">                log.file.path: &quot;/namespace-name&quot;</span><br><span class="hljs-string">            - and:</span><br><span class="hljs-string">                - contains:</span><br><span class="hljs-string">                    log.file.path: &quot;xxx&quot;</span><br><span class="hljs-string">                - contains:</span><br><span class="hljs-string">                    log.file.path: &quot;xxx&quot;</span><br><span class="hljs-string">      then:</span><br><span class="hljs-string">        - copy_fields:</span><br><span class="hljs-string">            fields:</span><br><span class="hljs-string">              - from: log.file.path</span><br><span class="hljs-string">                to: log_file_path</span><br><span class="hljs-string">        - drop_fields:</span><br><span class="hljs-string">            fields: [&quot;input&quot;, &quot;agent&quot;, &quot;ecs&quot;, &quot;log&quot;]</span><br><span class="hljs-string">        - add_fields:</span><br><span class="hljs-string">            target: &quot;&quot;</span><br><span class="hljs-string">            fields:</span><br><span class="hljs-string">              namespace: &quot;&quot;</span><br><span class="hljs-string">              pod: &quot;&quot;</span><br><span class="hljs-string">              service: &quot;&quot;</span><br><span class="hljs-string">              log_type: &quot;pod&quot;</span><br><span class="hljs-string">              cluster: &quot;xxx&quot;</span><br><span class="hljs-string">      else:</span><br><span class="hljs-string">        if:</span><br><span class="hljs-string">          or:</span><br><span class="hljs-string">            - contains:</span><br><span class="hljs-string">                log.file.path: &quot;/messages&quot;</span><br><span class="hljs-string">            - contains:</span><br><span class="hljs-string">                log.file.path: &quot;/syslog&quot;</span><br><span class="hljs-string">        then:</span><br><span class="hljs-string">          - copy_fields:</span><br><span class="hljs-string">              fields:</span><br><span class="hljs-string">                - from: log.file.path</span><br><span class="hljs-string">                  to: log_file_path</span><br><span class="hljs-string">          - drop_fields:</span><br><span class="hljs-string">              fields: [&quot;input&quot;, &quot;agent&quot;, &quot;ecs&quot;, &quot;log&quot;]</span><br><span class="hljs-string">          - add_fields:</span><br><span class="hljs-string">              target：&quot;&quot;</span><br><span class="hljs-string">              fields:</span><br><span class="hljs-string">                log_type: &quot;syslog&quot;</span><br><span class="hljs-string">                cluster: &quot;xxx&quot;</span><br><span class="hljs-string">        else:</span><br><span class="hljs-string">          - drop_event: &#123;&#125;</span><br><span class="hljs-string">    output.kafka:</span><br><span class="hljs-string">      hosts: [&quot;kafka.ops.svc:9092&quot;]</span><br><span class="hljs-string">      topics:</span><br><span class="hljs-string">       - topic: &quot;log-collector&quot;</span><br><span class="hljs-string">         when.equals:</span><br><span class="hljs-string">           log_type: &quot;pod&quot;</span><br><span class="hljs-string">       - topic: &quot;syslog&quot;</span><br><span class="hljs-string">         when.equals:</span><br><span class="hljs-string">           log_type: &quot;syslog&quot;</span><br></code></pre></td></tr></table></figure><p>如果希望将不同服务的日志写入到不同的 Kafka topic 中，可以参照如下配置：</p><blockquote><p>filebeat_cm.yml</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">filebeat-config</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">filebeat.yml:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    filebeat.inputs:</span><br><span class="hljs-string">    - type: filestream</span><br><span class="hljs-string">      id: filebeat</span><br><span class="hljs-string">      paths:</span><br><span class="hljs-string">        - /var/log/pods/**/*.log</span><br><span class="hljs-string">      fields:</span><br><span class="hljs-string">        hostname: $&#123;HOSTNAME&#125;</span><br><span class="hljs-string">      fields_under_root: true</span><br><span class="hljs-string"></span><br>    <span class="hljs-attr">processors:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">if:</span><br>        <span class="hljs-attr">or:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">contains:</span><br>              <span class="hljs-attr">log.file.path:</span> <span class="hljs-string">&quot;/namespace-1&quot;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">contains:</span><br>              <span class="hljs-attr">log.file.path:</span> <span class="hljs-string">&quot;/namespace-2&quot;</span><br>      <span class="hljs-attr">then:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">drop_event:</span><br>            <span class="hljs-attr">when:</span><br>              <span class="hljs-attr">contains:</span><br>                <span class="hljs-attr">log.file.path:</span> <span class="hljs-string">&quot;daprd&quot;</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">copy_fields:</span><br>            <span class="hljs-attr">fields:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-attr">from:</span> <span class="hljs-string">log.file.path</span><br>                <span class="hljs-attr">to:</span> <span class="hljs-string">log_file_path</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">drop_fields:</span><br>            <span class="hljs-attr">fields:</span> [<span class="hljs-string">&quot;input&quot;</span>, <span class="hljs-string">&quot;agent&quot;</span>, <span class="hljs-string">&quot;ecs&quot;</span>, <span class="hljs-string">&quot;log&quot;</span>]<br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">add_fields:</span><br>            <span class="hljs-attr">target:</span> <span class="hljs-string">&quot;&quot;</span><br>            <span class="hljs-attr">fields:</span><br>              <span class="hljs-attr">namespace:</span> <span class="hljs-string">&quot;&quot;</span><br>              <span class="hljs-attr">pod:</span> <span class="hljs-string">&quot;&quot;</span><br>              <span class="hljs-attr">service:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-attr">else:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">drop_event:</span> &#123;&#125;<br><br>    <span class="hljs-attr">output.kafka:</span><br>      <span class="hljs-attr">hosts:</span> [<span class="hljs-string">&quot;kafka.ops.svc:9092&quot;</span>]<br>      <span class="hljs-attr">topics:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">topic:</span> <span class="hljs-string">&quot;log-collector&quot;</span><br>          <span class="hljs-attr">when.contains:</span><br>            <span class="hljs-attr">log_file_path:</span> <span class="hljs-string">&quot;/namespace-1&quot;</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">topic:</span> <span class="hljs-string">&quot;log-collector-2&quot;</span><br>          <span class="hljs-attr">when.contains:</span><br>            <span class="hljs-attr">log_file_path:</span> <span class="hljs-string">&quot;/namespace-2&quot;</span><br></code></pre></td></tr></table></figure><h3 id="DaemonSet-配置"><a href="#DaemonSet-配置" class="headerlink" title="DaemonSet 配置"></a>DaemonSet 配置</h3><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tcl">kubectl <span class="hljs-keyword">apply</span> -f filebeat_ds.yml -n &lt;<span class="hljs-keyword">namespace</span>&gt;<br></code></pre></td></tr></table></figure><blockquote><p>filebeat_ds.yml</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">annotations:</span> &#123;&#125;<br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">filebeat</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">filebeat-daemonset</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">filebeat</span><br>  <span class="hljs-attr">updateStrategy:</span><br>    <span class="hljs-attr">rollingUpdate:</span><br>      <span class="hljs-attr">maxUnavailable:</span> <span class="hljs-number">1</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">RollingUpdate</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">filebeat</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">tolerations:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">effect:</span> <span class="hljs-string">NoSchedule</span><br>        <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">filebeat</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">docker.elastic.co/beats/filebeat:8.5.1</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">readinessProbe:</span><br>          <span class="hljs-attr">exec:</span><br>            <span class="hljs-attr">command:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">pgrep</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">filebeat</span><br>          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">10</span><br>          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span><br>          <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span><br>          <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">1</span><br>        <span class="hljs-attr">livenessProbe:</span><br>          <span class="hljs-attr">exec:</span><br>            <span class="hljs-attr">command:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">pgrep</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">filebeat</span><br>          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">20</span><br>          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">30</span><br>          <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span><br>          <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">3</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">100Mi</span><br>          <span class="hljs-attr">limits:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">1000m</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">200Mi</span><br>        <span class="hljs-attr">env:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">HOSTNAME</span><br>          <span class="hljs-attr">valueFrom:</span><br>            <span class="hljs-attr">fieldRef:</span><br>              <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">spec.nodeName</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/usr/share/filebeat/filebeat.yml</span><br>          <span class="hljs-attr">subPath:</span> <span class="hljs-string">filebeat.yml</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">filebeat-config</span><br>          <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/log/pods</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">pods-log</span><br>          <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/usr/share/filebeat/data</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">filebeat-data</span><br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">configMap:</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">filebeat-config</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">filebeat-config</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">hostPath:</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">/var/log/pods</span><br>          <span class="hljs-attr">type:</span> <span class="hljs-string">Directory</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">pods-log</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">hostPath:</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">/var/lib/filebeat-data</span><br>          <span class="hljs-attr">type:</span> <span class="hljs-string">Directory</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">filebeat-data</span><br></code></pre></td></tr></table></figure><h3 id="Kafka-消息格式"><a href="#Kafka-消息格式" class="headerlink" title="Kafka 消息格式"></a>Kafka 消息格式</h3><blockquote><p>Filebeat 发往 Kafka 的消息格式如下：</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;@timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2023-03-10T08:04:57.458Z&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;@metadata&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;beat&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;filebeat&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;8.5.1&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;filebeat-daemonset-1234&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;log_file_path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/var/log/pods/&lt;namespace&gt;_&lt;pod&gt;_xxxx/&lt;service&gt;/0.log&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2023-03-01T01:38:10.281346082+08:00 stdout F &#123;\&quot;@timestamp\&quot;:\&quot;2023-03-01T01:38:10.281+08:00\&quot;,\&quot;content\&quot;:\&quot;detail message\&quot;,\&quot;level\&quot;:\&quot;info\&quot;&#125;&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;namespace&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;pod&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;service&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hostname&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;node123&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h2 id="Logstash-配置"><a href="#Logstash-配置" class="headerlink" title="Logstash 配置"></a>Logstash 配置</h2><p>Logstash 主要负责处理如下流程：</p><ul><li>从 Kakfa 中读取消息</li><li>从 <code>log_file_path</code> 中提取 <code>namespace</code>、<code>pod</code>、<code>service</code> 等信息</li><li>从 <code>message</code> 字段中移除 K8s 自动添加的日志前缀 <code>2023-03-01T01:38:10.281346082+08:00 stdout F </code>，并将日志中的 json 字符串转换成 json 对象【如果 Pod 打印的不是 json 格式的，则不需要进行转换】</li></ul><h3 id="input"><a href="#input" class="headerlink" title="input"></a>input</h3><ul><li><a href="https://www.elastic.co/guide/en/logstash/current/plugins-inputs-kafka.html">kafka 配置</a></li></ul><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs toml">input &#123;<br>    kafka &#123;<br>        <span class="hljs-attr">id</span> =&gt; <span class="hljs-string">&quot;log-collector&quot;</span><br>        <span class="hljs-attr">type</span> =&gt; <span class="hljs-string">&quot;log-collector&quot;</span><br>        <span class="hljs-attr">bootstrap_servers</span> =&gt; <span class="hljs-string">&quot;kafka.ops.svc:9092&quot;</span><br>        <span class="hljs-attr">topics</span> =&gt; [<span class="hljs-string">&quot;log-collector&quot;</span>]<br>        <span class="hljs-attr">client_dns_lookup</span> =&gt; <span class="hljs-string">&quot;use_all_dns_ips&quot;</span><br>        <span class="hljs-attr">client_id</span> =&gt; <span class="hljs-string">&quot;log-collector&quot;</span><br>        <span class="hljs-attr">group_id</span> =&gt; <span class="hljs-string">&quot;log-collector&quot;</span><br>        <span class="hljs-attr">decorate_events</span> =&gt; <span class="hljs-string">&quot;basic&quot;</span><br>        <span class="hljs-attr">auto_offset_reset</span> =&gt; <span class="hljs-string">&quot;latest&quot;</span><br>        <span class="hljs-attr">consumer_threads</span> =&gt; <span class="hljs-number">4</span><br>    &#125;<br>    kafka &#123;<br>        <span class="hljs-attr">id</span> =&gt; <span class="hljs-string">&quot;syslog&quot;</span><br>        <span class="hljs-attr">type</span> =&gt; <span class="hljs-string">&quot;syslog&quot;</span><br>        <span class="hljs-attr">bootstrap_servers</span> =&gt; <span class="hljs-string">&quot;kafka.ops.svc:9092&quot;</span><br>        <span class="hljs-attr">topics</span> =&gt; [<span class="hljs-string">&quot;syslog&quot;</span>]<br>        <span class="hljs-attr">client_dns_lookup</span> =&gt; <span class="hljs-string">&quot;use_all_dns_ips&quot;</span><br>        <span class="hljs-attr">client_id</span> =&gt; <span class="hljs-string">&quot;syslog&quot;</span><br>        <span class="hljs-attr">group_id</span> =&gt; <span class="hljs-string">&quot;syslog&quot;</span><br>        <span class="hljs-attr">decorate_events</span> =&gt; <span class="hljs-string">&quot;basic&quot;</span><br>        <span class="hljs-attr">auto_offset_reset</span> =&gt; <span class="hljs-string">&quot;latest&quot;</span><br>        <span class="hljs-attr">consumer_threads</span> =&gt; <span class="hljs-number">4</span><br>      &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h3><ul><li><code>json</code>：从 Kafka 中读取消息，并将原始的消息转换为 json 格式。<code>input</code> 插件读取后是字符串格式</li><li><code>ruby</code>：从 <code>log_file_path</code> 中提取 <code>namespace</code>、<code>pod</code>、<code>service</code> 等信息，并赋值给相应字段</li><li><code>grok</code>：从 <code>message</code> 字段中移除 K8s 自动加的前缀信息，并将业务记录的日志记录到 <code>message_content</code> 字段<ul><li><a href="https://grokdebugger.com/">Grok Debugger</a>：在线调试 grok 规则</li><li><a href="https://github.com/logstash-plugins/logstash-patterns-core/blob/main/patterns/ecs-v1/grok-patterns">Grok Patterns</a>：常用的 grok 规则</li></ul></li><li><code>json</code>：将提取的 <code>message_content</code> 转换成 json 格式</li></ul><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs toml">filter &#123;<br>  if <span class="hljs-section">[type]</span> == &quot;pod&quot; &#123;<br>    json &#123;<br>      <span class="hljs-attr">source</span> =&gt; <span class="hljs-string">&quot;message&quot;</span><br>      <span class="hljs-attr">skip_on_invalid_json</span> =&gt; <span class="hljs-literal">true</span><br>      <span class="hljs-attr">remove_field</span> =&gt; [<span class="hljs-string">&quot;event&quot;</span>]<br>    &#125;<br><br>    ruby &#123;<br>      <span class="hljs-attr">code</span> =&gt; <span class="hljs-string">&quot;</span><br><span class="hljs-string">      log_file_path = event.get(&#x27;log_file_path&#x27;)</span><br><span class="hljs-string">      log_file_name = log_file_path.sub(&#x27;/var/log/pods/&#x27;, &#x27;&#x27;)</span><br><span class="hljs-string">      namespace, pod = log_file_name.split(&#x27;_&#x27;)[0, 2]</span><br><span class="hljs-string">      service = log_file_name.split(&#x27;/&#x27;)[-2]</span><br><span class="hljs-string">      event.set(&#x27;namespace&#x27;, namespace)</span><br><span class="hljs-string">      event.set(&#x27;pod&#x27;, pod)</span><br><span class="hljs-string">      event.set(&#x27;service&#x27;, service)</span><br><span class="hljs-string">      &quot;</span><br>    &#125;<br><br>    grok &#123;<br>      <span class="hljs-attr">match</span> =&gt; &#123;<br>        <span class="hljs-attr">&quot;message&quot;</span> =&gt; <span class="hljs-string">&quot;%&#123;TIMESTAMP_ISO8601&#125; %&#123;WORD&#125; %&#123;WORD&#125; %&#123;GREEDYDATA:message_content&#125;&quot;</span><br>      &#125;<br>    &#125;<br><br>    json &#123;<br>      <span class="hljs-attr">source</span> =&gt; <span class="hljs-string">&quot;message_content&quot;</span><br>      <span class="hljs-attr">remove_field</span> =&gt; [<span class="hljs-string">&quot;message_content&quot;</span>]<br>      <span class="hljs-attr">skip_on_invalid_json</span> =&gt; <span class="hljs-literal">true</span><br>    &#125;<br>  &#125; else if <span class="hljs-section">[type]</span> == &quot;syslog&quot; &#123;<br>    json &#123;<br>      <span class="hljs-attr">source</span> =&gt; <span class="hljs-string">&quot;message&quot;</span><br>      <span class="hljs-attr">skip_on_invalid_json</span> =&gt; <span class="hljs-literal">true</span><br>      <span class="hljs-attr">remove_field</span> =&gt; [<span class="hljs-string">&quot;event&quot;</span>]<br>    &#125;<br><br>    grok &#123;<br>      <span class="hljs-attr">match</span> =&gt; &#123;<br>        <span class="hljs-attr">&quot;message&quot;</span> =&gt; <span class="hljs-string">&quot;%&#123;SYSLOGTIMESTAMP:ts&#125; %&#123;SYSLOGHOST:log_host&#125; %&#123;PROG:program&#125;(?:\[%&#123;POSINT:pid&#125;\])?: %&#123;GREEDYDATA:message_content&#125;&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="output"><a href="#output" class="headerlink" title="output"></a>output</h3><p>将处理后的消息写入 Elasticsearch，其中 <code>index</code> 字段为创建的 datastream</p><div class="note note-info">            <p>如果要为每一条写入 Elasticsearch 的数据记录其在 Kafka 中的信息，可以设置：<code>document_id =&gt; &quot;%{[@metadata][kafka][partition]}-%{[@metadata][kafka][offset]}&quot;</code>。但由于 Filebeat 写入 Kafka 的消息默认含有 <code>@metadata</code> 字段，所以按照上述的配置，<code>document_id</code> 是不生效的。可以在 filter &#x2F; json 中配置 <code>target =&gt; &quot;doc&quot;</code>，则 Filebeat 的 <code>@metadata</code> 字段会转换到 <code>[doc][@metadata]</code> 字段中，不会再覆盖 Kakfa 添加的 <code>@metadata</code>。相应的，其他 Filebeat 消息也需要调整为从 <code>[doc][...]</code> 字段中获得</p>          </div><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs toml">output &#123;<br>  if <span class="hljs-section">[type]</span> == &quot;pod&quot; &#123;<br>    elasticsearch &#123;<br>      <span class="hljs-attr">hosts</span> =&gt; [ <span class="hljs-string">&quot;$&#123;ES_HOST&#125;&quot;</span> ]<br>      <span class="hljs-attr">user</span> =&gt; <span class="hljs-string">&quot;$&#123;ES_USERNAME&#125;&quot;</span><br>      <span class="hljs-attr">password</span> =&gt; <span class="hljs-string">&quot;$&#123;ES_PASSWORD&#125;&quot;</span><br>      <span class="hljs-attr">index</span> =&gt; <span class="hljs-string">&quot;log-collector&quot;</span><br>      <span class="hljs-attr">action</span> =&gt; <span class="hljs-string">&quot;create&quot;</span><br>    &#125;<br>  &#125; else if <span class="hljs-section">[type]</span> == &quot;syslog&quot; &#123;<br>    elasticsearch &#123;<br>      <span class="hljs-attr">hosts</span> =&gt; [ <span class="hljs-string">&quot;$&#123;ES_HOST&#125;&quot;</span> ]<br>      <span class="hljs-attr">user</span> =&gt; <span class="hljs-string">&quot;$&#123;ES_USERNAME&#125;&quot;</span><br>      <span class="hljs-attr">password</span> =&gt; <span class="hljs-string">&quot;$&#123;ES_PASSWORD&#125;&quot;</span><br>      <span class="hljs-attr">index</span> =&gt; <span class="hljs-string">&quot;syslog&quot;</span><br>      <span class="hljs-attr">action</span> =&gt; <span class="hljs-string">&quot;create&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Elasticsearch-配置"><a href="#Elasticsearch-配置" class="headerlink" title="Elasticsearch 配置"></a>Elasticsearch 配置</h2><ul><li>创建 datastream 用于存储 Logstash 的发来的消息</li><li>datastream 需要依次创建<ul><li>life cycle</li><li>component mappings &amp; settings</li><li>index template</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>Kubernetes</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Kubernetes</tag>
      
      <tag>Filebeat</tag>
      
      <tag>ELK</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
